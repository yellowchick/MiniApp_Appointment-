### 日程系统功能测试

#### 测试用例：创建和获取日程

```javascript
async function testScheduleOperations() {
  console.group('📅 日程系统测试');
  
  try {
    // 1. 创建测试日程
    const createRes = await wx.cloud.callFunction({
      name: 'schedule-service',
      data: {
        action: 'save',
        data: {
          eventDates: ['2023-12-15', '2023-12-16'],
          name: '测试用户',
          title: '测试职位'
        }
      }
    });
    console.log('日程创建结果:', createRes.result);
    
    // 2. 获取用户日程
    const userRes = await wx.cloud.callFunction({
      name: 'schedule-service',
      data: {
        action: 'getByUser',
        data: { userId: 'test_user_1' }
      }
    });
    
    if (userRes.result.data && userRes.result.data.eventDates) {
      console.log('✅ 获取用户日程成功');
      console.log('日程日期:', userRes.result.data.eventDates);
    } else {
      console.error('❌ 获取用户日程失败');
    }
    
    // 3. 生成分享令牌
    const tokenRes = await wx.cloud.callFunction({
      name: 'schedule-service',
      data: {
        action: 'generateToken'
      }
    });
    
    if (tokenRes.result.data && tokenRes.result.data.token) {
      console.log('✅ 生成分享令牌成功');
      const shareToken = tokenRes.result.data.token;
      
      // 4. 通过令牌获取日程
      const shareRes = await wx.cloud.callFunction({
        name: 'schedule-service',
        data: {
          action: 'getByToken',
          data: { token: shareToken }
        }
      });
      
      if (shareRes.result.data) {
        console.log('✅ 通过令牌获取日程成功');
      } else {
        console.error('❌ 通过令牌获取日程失败');
      }
    } else {
      console.error('❌ 生成分享令牌失败');
    }
    
  } catch (error) {
    console.error('测试失败:', error);
  }
  
  console.groupEnd();
}

// 执行测试
testScheduleOperations();
```





- 修复变量作用域

- OPENID获取替换为login

- 日程ID获取增强
- 安全清理

```javascript
async function testScheduleOperations() {
  console.group('📅 日程系统测试');
  let scheduleId = null; // 在函数作用域声明
  
  try {
    // 0. 获取当前用户openid - 使用替代方案
    const userInfo = await wx.cloud.callFunction({ name: 'login' }); // 尝试通用登录函数
    const currentOpenid = userInfo.result.openid;
    console.log('当前用户ID:', currentOpenid);
    
    // 1. 创建测试日程
    const createRes = await wx.cloud.callFunction({
      name: 'schedule-service',
      data: {
        action: 'save',
        data: {
          userId: currentOpenid,
          eventDates: ['2025-08-20', '2025-08-21'],
          name: '测试用户',
          title: '测试职位'
        }
      }
    });
    
    // 获取日程ID - 兼容不同返回结构
    scheduleId = createRes.result?.event?._id || 
                createRes.result?.data?._id || 
                createRes.result?._id;
    
    if (!scheduleId) {
      throw new Error('无法获取日程ID，返回结果: ' + JSON.stringify(createRes));
    }
    console.log('日程创建成功, ID:', scheduleId);
    
    // 2. 获取用户日程
    const userRes = await wx.cloud.callFunction({
      name: 'schedule-service',
      data: {
        action: 'getByUser',
        data: { userId: currentOpenid }
      }
    });
    
    if (userRes.result.data && Array.isArray(userRes.result.data)) {
      const found = userRes.result.data.some(item => item._id === scheduleId);
      console.log(found ? '✅ 获取用户日程成功' : '❌ 未找到测试日程');
    } else {
      console.error('❌ 返回数据结构异常:', userRes.result);
    }
    
    // 3. 生成分享令牌
    const tokenRes = await wx.cloud.callFunction({
      name: 'schedule-service',
      data: {
        action: 'generateToken',
        data: { scheduleId }
      }
    });
    
    if (tokenRes.result.data?.token) {
      console.log('✅ 生成分享令牌成功');
      const shareToken = tokenRes.result.data.token;
      
      // 4. 通过令牌获取日程
      const shareRes = await wx.cloud.callFunction({
        name: 'schedule-service',
        data: {
          action: 'getByToken',
          data: { token: shareToken }
        }
      });
      
      if (shareRes.result.data?._id === scheduleId) {
        console.log('✅ 通过令牌获取日程成功');
      } else {
        console.error('❌ 令牌返回的日程ID不匹配');
      }
    } else {
      console.error('❌ 生成分享令牌失败:', tokenRes.result);
    }
    
  } catch (error) {
    console.error('测试失败:', error);
  } finally {
    // 5. 清理测试数据 - 添加存在检查
    if (scheduleId) {
      console.log('清理测试日程:', scheduleId);
      try {
        await wx.cloud.callFunction({
          name: 'test-cleanup',
          data: {
            collection: 'schedules',
            id: scheduleId
          }
        });
        console.log('✅ 测试日程清理完成');
      } catch (cleanError) {
        console.error('清理失败:', cleanError);
      }
    } else {
      console.log('无日程数据需要清理');
    }
    console.groupEnd();
  }
}

// 执行测试
testScheduleOperations();
```





- 看起来测试基本成功了，但有一个小问题：在获取用户日程时出现了"返回数据结构异常"的提示。这是因为测试代码期望返回一个数组，但云函数返回的是一个对象（单个日程）。

```javascript
async function testScheduleOperations() {
  console.group('📅 日程系统测试');
  let scheduleId = null;
  
  try {
    // 0. 获取当前用户openid
    const userInfo = await wx.cloud.callFunction({ name: 'login' });
    const currentOpenid = userInfo.result.openid;
    console.log('当前用户ID:', currentOpenid);
    
    // 1. 创建测试日程
    const createRes = await wx.cloud.callFunction({
      name: 'schedule-service',
      data: {
        action: 'save',
        data: {
          userId: currentOpenid,
          eventDates: ['2025-08-20', '2025-08-21'],
          name: '测试用户',
          title: '测试职位'
        }
      }
    });
    
    // 获取日程ID
    if (createRes.result.code === 200) {
      scheduleId = createRes.result.data._id;
      console.log('日程创建成功, ID:', scheduleId);
    } else {
      throw new Error('日程创建失败: ' + createRes.result.message);
    }
    
    // 2. 获取用户日程
    const userRes = await wx.cloud.callFunction({
      name: 'schedule-service',
      data: {
        action: 'getByUser',
        data: { userId: currentOpenid }
      }
    });
    
    // 修复这部分代码 - 云函数返回的是单个对象，不是数组
    if (userRes.result.code === 200) {
      if (userRes.result.data && userRes.result.data._id === scheduleId) {
        console.log('✅ 获取用户日程成功');
        console.log('日程日期:', userRes.result.data.eventDates);
      } else {
        console.error('❌ 未找到测试日程');
        console.log('返回数据:', userRes.result.data);
      }
    } else {
      console.error('❌ 获取用户日程失败:', userRes.result.message);
    }
    
    // 3. 生成分享令牌
    const tokenRes = await wx.cloud.callFunction({
      name: 'schedule-service',
      data: {
        action: 'generateToken',
        data: { scheduleId }
      }
    });
    
    if (tokenRes.result.code === 200 && tokenRes.result.data.token) {
      console.log('✅ 生成分享令牌成功');
      const shareToken = tokenRes.result.data.token;
      
      // 4. 通过令牌获取日程
      const shareRes = await wx.cloud.callFunction({
        name: 'schedule-service',
        data: {
          action: 'getByToken',
          data: { token: shareToken }
        }
      });
      
      if (shareRes.result.code === 200 && shareRes.result.data._id === scheduleId) {
        console.log('✅ 通过令牌获取日程成功');
      } else {
        console.error('❌ 通过令牌获取日程失败:', shareRes.result.message);
      }
    } else {
      console.error('❌ 生成分享令牌失败:', tokenRes.result.message);
    }
    
  } catch (error) {
    console.error('测试失败:', error);
  } finally {
    // 5. 清理测试数据
    if (scheduleId) {
      console.log('清理测试日程:', scheduleId);
      try {
        await wx.cloud.callFunction({
          name: 'test-cleanup',
          data: {
            collection: 'schedules',
            id: scheduleId
          }
        });
        console.log('✅ 测试日程清理完成');
      } catch (cleanError) {
        console.error('清理失败:', cleanError);
      }
    } else {
      console.log('无日程数据需要清理');
    }
    console.groupEnd();
  }
}

// 执行测试
testScheduleOperations();
```





日程系统功能测试完成，down！
