### æ—¥ç¨‹ç³»ç»ŸåŠŸèƒ½æµ‹è¯•

#### æµ‹è¯•ç”¨ä¾‹ï¼šåˆ›å»ºå’Œè·å–æ—¥ç¨‹

```javascript
async function testScheduleOperations() {
  console.group('ğŸ“… æ—¥ç¨‹ç³»ç»Ÿæµ‹è¯•');
  
  try {
    // 1. åˆ›å»ºæµ‹è¯•æ—¥ç¨‹
    const createRes = await wx.cloud.callFunction({
      name: 'schedule-service',
      data: {
        action: 'save',
        data: {
          eventDates: ['2023-12-15', '2023-12-16'],
          name: 'æµ‹è¯•ç”¨æˆ·',
          title: 'æµ‹è¯•èŒä½'
        }
      }
    });
    console.log('æ—¥ç¨‹åˆ›å»ºç»“æœ:', createRes.result);
    
    // 2. è·å–ç”¨æˆ·æ—¥ç¨‹
    const userRes = await wx.cloud.callFunction({
      name: 'schedule-service',
      data: {
        action: 'getByUser',
        data: { userId: 'test_user_1' }
      }
    });
    
    if (userRes.result.data && userRes.result.data.eventDates) {
      console.log('âœ… è·å–ç”¨æˆ·æ—¥ç¨‹æˆåŠŸ');
      console.log('æ—¥ç¨‹æ—¥æœŸ:', userRes.result.data.eventDates);
    } else {
      console.error('âŒ è·å–ç”¨æˆ·æ—¥ç¨‹å¤±è´¥');
    }
    
    // 3. ç”Ÿæˆåˆ†äº«ä»¤ç‰Œ
    const tokenRes = await wx.cloud.callFunction({
      name: 'schedule-service',
      data: {
        action: 'generateToken'
      }
    });
    
    if (tokenRes.result.data && tokenRes.result.data.token) {
      console.log('âœ… ç”Ÿæˆåˆ†äº«ä»¤ç‰ŒæˆåŠŸ');
      const shareToken = tokenRes.result.data.token;
      
      // 4. é€šè¿‡ä»¤ç‰Œè·å–æ—¥ç¨‹
      const shareRes = await wx.cloud.callFunction({
        name: 'schedule-service',
        data: {
          action: 'getByToken',
          data: { token: shareToken }
        }
      });
      
      if (shareRes.result.data) {
        console.log('âœ… é€šè¿‡ä»¤ç‰Œè·å–æ—¥ç¨‹æˆåŠŸ');
      } else {
        console.error('âŒ é€šè¿‡ä»¤ç‰Œè·å–æ—¥ç¨‹å¤±è´¥');
      }
    } else {
      console.error('âŒ ç”Ÿæˆåˆ†äº«ä»¤ç‰Œå¤±è´¥');
    }
    
  } catch (error) {
    console.error('æµ‹è¯•å¤±è´¥:', error);
  }
  
  console.groupEnd();
}

// æ‰§è¡Œæµ‹è¯•
testScheduleOperations();
```





- ä¿®å¤å˜é‡ä½œç”¨åŸŸ

- OPENIDè·å–æ›¿æ¢ä¸ºlogin

- æ—¥ç¨‹IDè·å–å¢å¼º
- å®‰å…¨æ¸…ç†

```javascript
async function testScheduleOperations() {
  console.group('ğŸ“… æ—¥ç¨‹ç³»ç»Ÿæµ‹è¯•');
  let scheduleId = null; // åœ¨å‡½æ•°ä½œç”¨åŸŸå£°æ˜
  
  try {
    // 0. è·å–å½“å‰ç”¨æˆ·openid - ä½¿ç”¨æ›¿ä»£æ–¹æ¡ˆ
    const userInfo = await wx.cloud.callFunction({ name: 'login' }); // å°è¯•é€šç”¨ç™»å½•å‡½æ•°
    const currentOpenid = userInfo.result.openid;
    console.log('å½“å‰ç”¨æˆ·ID:', currentOpenid);
    
    // 1. åˆ›å»ºæµ‹è¯•æ—¥ç¨‹
    const createRes = await wx.cloud.callFunction({
      name: 'schedule-service',
      data: {
        action: 'save',
        data: {
          userId: currentOpenid,
          eventDates: ['2025-08-20', '2025-08-21'],
          name: 'æµ‹è¯•ç”¨æˆ·',
          title: 'æµ‹è¯•èŒä½'
        }
      }
    });
    
    // è·å–æ—¥ç¨‹ID - å…¼å®¹ä¸åŒè¿”å›ç»“æ„
    scheduleId = createRes.result?.event?._id || 
                createRes.result?.data?._id || 
                createRes.result?._id;
    
    if (!scheduleId) {
      throw new Error('æ— æ³•è·å–æ—¥ç¨‹IDï¼Œè¿”å›ç»“æœ: ' + JSON.stringify(createRes));
    }
    console.log('æ—¥ç¨‹åˆ›å»ºæˆåŠŸ, ID:', scheduleId);
    
    // 2. è·å–ç”¨æˆ·æ—¥ç¨‹
    const userRes = await wx.cloud.callFunction({
      name: 'schedule-service',
      data: {
        action: 'getByUser',
        data: { userId: currentOpenid }
      }
    });
    
    if (userRes.result.data && Array.isArray(userRes.result.data)) {
      const found = userRes.result.data.some(item => item._id === scheduleId);
      console.log(found ? 'âœ… è·å–ç”¨æˆ·æ—¥ç¨‹æˆåŠŸ' : 'âŒ æœªæ‰¾åˆ°æµ‹è¯•æ—¥ç¨‹');
    } else {
      console.error('âŒ è¿”å›æ•°æ®ç»“æ„å¼‚å¸¸:', userRes.result);
    }
    
    // 3. ç”Ÿæˆåˆ†äº«ä»¤ç‰Œ
    const tokenRes = await wx.cloud.callFunction({
      name: 'schedule-service',
      data: {
        action: 'generateToken',
        data: { scheduleId }
      }
    });
    
    if (tokenRes.result.data?.token) {
      console.log('âœ… ç”Ÿæˆåˆ†äº«ä»¤ç‰ŒæˆåŠŸ');
      const shareToken = tokenRes.result.data.token;
      
      // 4. é€šè¿‡ä»¤ç‰Œè·å–æ—¥ç¨‹
      const shareRes = await wx.cloud.callFunction({
        name: 'schedule-service',
        data: {
          action: 'getByToken',
          data: { token: shareToken }
        }
      });
      
      if (shareRes.result.data?._id === scheduleId) {
        console.log('âœ… é€šè¿‡ä»¤ç‰Œè·å–æ—¥ç¨‹æˆåŠŸ');
      } else {
        console.error('âŒ ä»¤ç‰Œè¿”å›çš„æ—¥ç¨‹IDä¸åŒ¹é…');
      }
    } else {
      console.error('âŒ ç”Ÿæˆåˆ†äº«ä»¤ç‰Œå¤±è´¥:', tokenRes.result);
    }
    
  } catch (error) {
    console.error('æµ‹è¯•å¤±è´¥:', error);
  } finally {
    // 5. æ¸…ç†æµ‹è¯•æ•°æ® - æ·»åŠ å­˜åœ¨æ£€æŸ¥
    if (scheduleId) {
      console.log('æ¸…ç†æµ‹è¯•æ—¥ç¨‹:', scheduleId);
      try {
        await wx.cloud.callFunction({
          name: 'test-cleanup',
          data: {
            collection: 'schedules',
            id: scheduleId
          }
        });
        console.log('âœ… æµ‹è¯•æ—¥ç¨‹æ¸…ç†å®Œæˆ');
      } catch (cleanError) {
        console.error('æ¸…ç†å¤±è´¥:', cleanError);
      }
    } else {
      console.log('æ— æ—¥ç¨‹æ•°æ®éœ€è¦æ¸…ç†');
    }
    console.groupEnd();
  }
}

// æ‰§è¡Œæµ‹è¯•
testScheduleOperations();
```





- çœ‹èµ·æ¥æµ‹è¯•åŸºæœ¬æˆåŠŸäº†ï¼Œä½†æœ‰ä¸€ä¸ªå°é—®é¢˜ï¼šåœ¨è·å–ç”¨æˆ·æ—¥ç¨‹æ—¶å‡ºç°äº†"è¿”å›æ•°æ®ç»“æ„å¼‚å¸¸"çš„æç¤ºã€‚è¿™æ˜¯å› ä¸ºæµ‹è¯•ä»£ç æœŸæœ›è¿”å›ä¸€ä¸ªæ•°ç»„ï¼Œä½†äº‘å‡½æ•°è¿”å›çš„æ˜¯ä¸€ä¸ªå¯¹è±¡ï¼ˆå•ä¸ªæ—¥ç¨‹ï¼‰ã€‚

```javascript
async function testScheduleOperations() {
  console.group('ğŸ“… æ—¥ç¨‹ç³»ç»Ÿæµ‹è¯•');
  let scheduleId = null;
  
  try {
    // 0. è·å–å½“å‰ç”¨æˆ·openid
    const userInfo = await wx.cloud.callFunction({ name: 'login' });
    const currentOpenid = userInfo.result.openid;
    console.log('å½“å‰ç”¨æˆ·ID:', currentOpenid);
    
    // 1. åˆ›å»ºæµ‹è¯•æ—¥ç¨‹
    const createRes = await wx.cloud.callFunction({
      name: 'schedule-service',
      data: {
        action: 'save',
        data: {
          userId: currentOpenid,
          eventDates: ['2025-08-20', '2025-08-21'],
          name: 'æµ‹è¯•ç”¨æˆ·',
          title: 'æµ‹è¯•èŒä½'
        }
      }
    });
    
    // è·å–æ—¥ç¨‹ID
    if (createRes.result.code === 200) {
      scheduleId = createRes.result.data._id;
      console.log('æ—¥ç¨‹åˆ›å»ºæˆåŠŸ, ID:', scheduleId);
    } else {
      throw new Error('æ—¥ç¨‹åˆ›å»ºå¤±è´¥: ' + createRes.result.message);
    }
    
    // 2. è·å–ç”¨æˆ·æ—¥ç¨‹
    const userRes = await wx.cloud.callFunction({
      name: 'schedule-service',
      data: {
        action: 'getByUser',
        data: { userId: currentOpenid }
      }
    });
    
    // ä¿®å¤è¿™éƒ¨åˆ†ä»£ç  - äº‘å‡½æ•°è¿”å›çš„æ˜¯å•ä¸ªå¯¹è±¡ï¼Œä¸æ˜¯æ•°ç»„
    if (userRes.result.code === 200) {
      if (userRes.result.data && userRes.result.data._id === scheduleId) {
        console.log('âœ… è·å–ç”¨æˆ·æ—¥ç¨‹æˆåŠŸ');
        console.log('æ—¥ç¨‹æ—¥æœŸ:', userRes.result.data.eventDates);
      } else {
        console.error('âŒ æœªæ‰¾åˆ°æµ‹è¯•æ—¥ç¨‹');
        console.log('è¿”å›æ•°æ®:', userRes.result.data);
      }
    } else {
      console.error('âŒ è·å–ç”¨æˆ·æ—¥ç¨‹å¤±è´¥:', userRes.result.message);
    }
    
    // 3. ç”Ÿæˆåˆ†äº«ä»¤ç‰Œ
    const tokenRes = await wx.cloud.callFunction({
      name: 'schedule-service',
      data: {
        action: 'generateToken',
        data: { scheduleId }
      }
    });
    
    if (tokenRes.result.code === 200 && tokenRes.result.data.token) {
      console.log('âœ… ç”Ÿæˆåˆ†äº«ä»¤ç‰ŒæˆåŠŸ');
      const shareToken = tokenRes.result.data.token;
      
      // 4. é€šè¿‡ä»¤ç‰Œè·å–æ—¥ç¨‹
      const shareRes = await wx.cloud.callFunction({
        name: 'schedule-service',
        data: {
          action: 'getByToken',
          data: { token: shareToken }
        }
      });
      
      if (shareRes.result.code === 200 && shareRes.result.data._id === scheduleId) {
        console.log('âœ… é€šè¿‡ä»¤ç‰Œè·å–æ—¥ç¨‹æˆåŠŸ');
      } else {
        console.error('âŒ é€šè¿‡ä»¤ç‰Œè·å–æ—¥ç¨‹å¤±è´¥:', shareRes.result.message);
      }
    } else {
      console.error('âŒ ç”Ÿæˆåˆ†äº«ä»¤ç‰Œå¤±è´¥:', tokenRes.result.message);
    }
    
  } catch (error) {
    console.error('æµ‹è¯•å¤±è´¥:', error);
  } finally {
    // 5. æ¸…ç†æµ‹è¯•æ•°æ®
    if (scheduleId) {
      console.log('æ¸…ç†æµ‹è¯•æ—¥ç¨‹:', scheduleId);
      try {
        await wx.cloud.callFunction({
          name: 'test-cleanup',
          data: {
            collection: 'schedules',
            id: scheduleId
          }
        });
        console.log('âœ… æµ‹è¯•æ—¥ç¨‹æ¸…ç†å®Œæˆ');
      } catch (cleanError) {
        console.error('æ¸…ç†å¤±è´¥:', cleanError);
      }
    } else {
      console.log('æ— æ—¥ç¨‹æ•°æ®éœ€è¦æ¸…ç†');
    }
    console.groupEnd();
  }
}

// æ‰§è¡Œæµ‹è¯•
testScheduleOperations();
```





æ—¥ç¨‹ç³»ç»ŸåŠŸèƒ½æµ‹è¯•å®Œæˆï¼Œdownï¼
