### 3. 端到端流程测试

#### 完整预约流程测试

```javascript
async function testFullBookingFlow() {
  console.group('🔁 端到端预约流程测试');
  
  try {
    // 1. 用户A创建日程
    console.log('用户A创建日程...');
    const scheduleRes = await wx.cloud.callFunction({
      name: 'schedule-service',
      data: {
        action: 'save',
        data: {
          eventDates: ['2023-12-10', '2023-12-11', '2023-12-12'],
          name: '用户A',
          title: '项目经理'
        }
      }
    });
    
    // 2. 用户A生成分享链接
    console.log('用户A生成分享令牌...');
    const tokenRes = await wx.cloud.callFunction({
      name: 'schedule-service',
      data: { action: 'generateToken' }
    });
    const shareToken = tokenRes.result.data.token;
    
    // 3. 用户B通过链接查看日程
    console.log('用户B查看共享日程...');
    const shareRes = await wx.cloud.callFunction({
      name: 'schedule-service',
      data: {
        action: 'getByToken',
        data: { token: shareToken }
      }
    });
    
    // 4. 用户B发送预约请求
    console.log('用户B发送预约请求...');
    const bookingRes = await wx.cloud.callFunction({
      name: 'notification-service',
      data: {
        action: 'create',
        data: {
          receiverId: 'userA_id', // 实际应为用户A的ID
          title: '预约请求',
          message: '用户B请求预约您的时间',
          type: 'incoming',
          details: {
            date: '2023-12-11',
            timeSlot: '14:00-15:00',
            purpose: '项目讨论'
          }
        }
      }
    });
    const notificationId = bookingRes.result.data.id;
    
    // 5. 用户A处理请求
    console.log('用户A处理预约请求...');
    await wx.cloud.callFunction({
      name: 'notification-service',
      data: {
        action: 'update',
        data: {
          id: notificationId,
          status: 'read',
          type: 'confirmed'
        }
      }
    });
    
    // 6. 用户B确认结果
    console.log('用户B确认结果...');
    const resultRes = await wx.cloud.callFunction({
      name: 'notification-service',
      data: {
        action: 'get',
        data: { id: notificationId }
      }
    });
    
    if (resultRes.result.data.type === 'confirmed') {
      console.log('✅ 端到端流程测试通过');
    } else {
      console.error('❌ 端到端流程测试失败');
    }
    
  } catch (error) {
    console.error('测试失败:', error);
  }
  
  console.groupEnd();
}

// 执行测试
testFullBookingFlow();
```





- ### 主要修复点

  1. **添加动态用户ID获取**：

     ```
     const userInfo = await wx.cloud.callFunction({ name: 'login' });
     currentUserOpenId = userInfo.result.openid;
     ```

  2. **修复生成令牌调用**：

     ```
     const tokenRes = await wx.cloud.callFunction({
       name: 'schedule-service',
       data: { 
         action: 'generateToken',
         data: { scheduleId } // 添加必要的日程ID参数
       }
     });
     ```

  3. **修复通知ID获取**：

     ```
     notificationId = bookingRes.result.data._id || bookingRes.result.data.id;
     ```

  4. **增强错误处理**：

     ```
     if (scheduleRes.result.code !== 200) {
       throw new Error('创建日程失败: ' + scheduleRes.result.message);
     }
     ```

  5. **添加数据清理**：

     ```
     // 在finally块中添加通知和日程的清理
     ```

  6. **更新日期格式**：

     ```
     eventDates: ['2025-08-15', '2025-08-16', '2025-08-17'], // 使用未来日期
     ```



- 修复后的测试代码

```javascript
async function testFullBookingFlow() {
  console.group('🔁 端到端预约流程测试');
  let scheduleId = null;
  let notificationId = null;
  let currentUserOpenId = null;
  
  try {
    // 0. 获取当前用户ID
    const userInfo = await wx.cloud.callFunction({ name: 'login' });
    currentUserOpenId = userInfo.result.openid;
    console.log('当前用户ID:', currentUserOpenId);
    
    // 1. 用户A创建日程
    console.log('用户A创建日程...');
    const scheduleRes = await wx.cloud.callFunction({
      name: 'schedule-service',
      data: {
        action: 'save',
        data: {
          userId: currentUserOpenId, // 添加用户ID
          eventDates: ['2025-08-15', '2025-08-16', '2025-08-17'],
          name: '用户A',
          title: '项目经理'
        }
      }
    });
    
    if (scheduleRes.result.code !== 200) {
      throw new Error('创建日程失败: ' + scheduleRes.result.message);
    }
    
    scheduleId = scheduleRes.result.data._id;
    console.log('日程创建成功, ID:', scheduleId);
    
    // 2. 用户A生成分享链接
    console.log('用户A生成分享令牌...');
    const tokenRes = await wx.cloud.callFunction({
      name: 'schedule-service',
      data: { 
        action: 'generateToken',
        data: { scheduleId } // 添加日程ID参数
      }
    });
    
    if (tokenRes.result.code !== 200) {
      throw new Error('生成令牌失败: ' + tokenRes.result.message);
    }
    
    const shareToken = tokenRes.result.data.token;
    console.log('分享令牌:', shareToken);
    
    // 3. 用户B通过链接查看日程
    console.log('用户B查看共享日程...');
    const shareRes = await wx.cloud.callFunction({
      name: 'schedule-service',
      data: {
        action: 'getByToken',
        data: { token: shareToken }
      }
    });
    
    if (shareRes.result.code !== 200) {
      throw new Error('通过令牌获取日程失败: ' + shareRes.result.message);
    }
    
    console.log('共享日程获取成功:', shareRes.result.data.title);
    
    // 4. 用户B发送预约请求
    console.log('用户B发送预约请求...');
    const bookingRes = await wx.cloud.callFunction({
      name: 'notification-service',
      data: {
        action: 'create',
        data: {
          receiverId: currentUserOpenId, // 使用动态用户ID
          title: '预约请求',
          message: '用户B请求预约您的时间',
          type: 'incoming',
          details: {
            date: '2025-08-16',
            timeSlot: '14:00-15:00',
            purpose: '项目讨论'
          }
        }
      }
    });
    
    if (bookingRes.result.code !== 200) {
      throw new Error('创建通知失败: ' + bookingRes.result.message);
    }
    
    // 修正ID获取方式
    notificationId = bookingRes.result.data._id || bookingRes.result.data.id;
    console.log('通知创建成功, ID:', notificationId);
    
    // 5. 用户A处理请求
    console.log('用户A处理预约请求...');
    const updateRes = await wx.cloud.callFunction({
      name: 'notification-service',
      data: {
        action: 'update',
        data: {
          id: notificationId,
          status: 'read',
          type: 'confirmed'
        }
      }
    });
    
    if (updateRes.result.code !== 200) {
      throw new Error('更新通知失败: ' + updateRes.result.message);
    }
    
    // 6. 用户B确认结果
    console.log('用户B确认结果...');
    const resultRes = await wx.cloud.callFunction({
      name: 'notification-service',
      data: {
        action: 'get',
        data: { id: notificationId }
      }
    });
    
    if (resultRes.result.code === 200 && resultRes.result.data.type === 'confirmed') {
      console.log('✅ 端到端流程测试通过');
    } else {
      console.error('❌ 端到端流程测试失败');
      console.log('最终通知状态:', resultRes.result.data);
    }
    
  } catch (error) {
    console.error('测试失败:', error);
  } finally {
    // 清理测试数据
    console.log('开始清理测试数据...');
    
    if (notificationId) {
      try {
        await wx.cloud.callFunction({
          name: 'test-cleanup',
          data: {
            collection: 'notifications',
            id: notificationId
          }
        });
        console.log('✅ 通知数据清理完成');
      } catch (cleanError) {
        console.error('通知清理失败:', cleanError);
      }
    }
    
    if (scheduleId) {
      try {
        await wx.cloud.callFunction({
          name: 'test-cleanup',
          data: {
            collection: 'schedules',
            id: scheduleId
          }
        });
        console.log('✅ 日程数据清理完成');
      } catch (cleanError) {
        console.error('日程清理失败:', cleanError);
      }
    }
    
    console.groupEnd();
  }
}

// 执行测试
testFullBookingFlow();
```



### 预期测试流程

1. 获取当前用户ID
2. 创建测试日程
3. 生成分享令牌
4. 通过令牌获取日程（验证分享功能）
5. 创建预约通知
6. 更新通知状态（模拟接受预约）
7. 验证最终状态
8. 清理测试数据





测试完成，down！