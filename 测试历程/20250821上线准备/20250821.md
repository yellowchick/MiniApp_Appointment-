### 3. ç«¯åˆ°ç«¯æµç¨‹æµ‹è¯•

#### å®Œæ•´é¢„çº¦æµç¨‹æµ‹è¯•

```javascript
async function testFullBookingFlow() {
  console.group('ğŸ” ç«¯åˆ°ç«¯é¢„çº¦æµç¨‹æµ‹è¯•');
  
  try {
    // 1. ç”¨æˆ·Aåˆ›å»ºæ—¥ç¨‹
    console.log('ç”¨æˆ·Aåˆ›å»ºæ—¥ç¨‹...');
    const scheduleRes = await wx.cloud.callFunction({
      name: 'schedule-service',
      data: {
        action: 'save',
        data: {
          eventDates: ['2023-12-10', '2023-12-11', '2023-12-12'],
          name: 'ç”¨æˆ·A',
          title: 'é¡¹ç›®ç»ç†'
        }
      }
    });
    
    // 2. ç”¨æˆ·Aç”Ÿæˆåˆ†äº«é“¾æ¥
    console.log('ç”¨æˆ·Aç”Ÿæˆåˆ†äº«ä»¤ç‰Œ...');
    const tokenRes = await wx.cloud.callFunction({
      name: 'schedule-service',
      data: { action: 'generateToken' }
    });
    const shareToken = tokenRes.result.data.token;
    
    // 3. ç”¨æˆ·Bé€šè¿‡é“¾æ¥æŸ¥çœ‹æ—¥ç¨‹
    console.log('ç”¨æˆ·BæŸ¥çœ‹å…±äº«æ—¥ç¨‹...');
    const shareRes = await wx.cloud.callFunction({
      name: 'schedule-service',
      data: {
        action: 'getByToken',
        data: { token: shareToken }
      }
    });
    
    // 4. ç”¨æˆ·Bå‘é€é¢„çº¦è¯·æ±‚
    console.log('ç”¨æˆ·Bå‘é€é¢„çº¦è¯·æ±‚...');
    const bookingRes = await wx.cloud.callFunction({
      name: 'notification-service',
      data: {
        action: 'create',
        data: {
          receiverId: 'userA_id', // å®é™…åº”ä¸ºç”¨æˆ·Açš„ID
          title: 'é¢„çº¦è¯·æ±‚',
          message: 'ç”¨æˆ·Bè¯·æ±‚é¢„çº¦æ‚¨çš„æ—¶é—´',
          type: 'incoming',
          details: {
            date: '2023-12-11',
            timeSlot: '14:00-15:00',
            purpose: 'é¡¹ç›®è®¨è®º'
          }
        }
      }
    });
    const notificationId = bookingRes.result.data.id;
    
    // 5. ç”¨æˆ·Aå¤„ç†è¯·æ±‚
    console.log('ç”¨æˆ·Aå¤„ç†é¢„çº¦è¯·æ±‚...');
    await wx.cloud.callFunction({
      name: 'notification-service',
      data: {
        action: 'update',
        data: {
          id: notificationId,
          status: 'read',
          type: 'confirmed'
        }
      }
    });
    
    // 6. ç”¨æˆ·Bç¡®è®¤ç»“æœ
    console.log('ç”¨æˆ·Bç¡®è®¤ç»“æœ...');
    const resultRes = await wx.cloud.callFunction({
      name: 'notification-service',
      data: {
        action: 'get',
        data: { id: notificationId }
      }
    });
    
    if (resultRes.result.data.type === 'confirmed') {
      console.log('âœ… ç«¯åˆ°ç«¯æµç¨‹æµ‹è¯•é€šè¿‡');
    } else {
      console.error('âŒ ç«¯åˆ°ç«¯æµç¨‹æµ‹è¯•å¤±è´¥');
    }
    
  } catch (error) {
    console.error('æµ‹è¯•å¤±è´¥:', error);
  }
  
  console.groupEnd();
}

// æ‰§è¡Œæµ‹è¯•
testFullBookingFlow();
```





- ### ä¸»è¦ä¿®å¤ç‚¹

  1. **æ·»åŠ åŠ¨æ€ç”¨æˆ·IDè·å–**ï¼š

     ```
     const userInfo = await wx.cloud.callFunction({ name: 'login' });
     currentUserOpenId = userInfo.result.openid;
     ```

  2. **ä¿®å¤ç”Ÿæˆä»¤ç‰Œè°ƒç”¨**ï¼š

     ```
     const tokenRes = await wx.cloud.callFunction({
       name: 'schedule-service',
       data: { 
         action: 'generateToken',
         data: { scheduleId } // æ·»åŠ å¿…è¦çš„æ—¥ç¨‹IDå‚æ•°
       }
     });
     ```

  3. **ä¿®å¤é€šçŸ¥IDè·å–**ï¼š

     ```
     notificationId = bookingRes.result.data._id || bookingRes.result.data.id;
     ```

  4. **å¢å¼ºé”™è¯¯å¤„ç†**ï¼š

     ```
     if (scheduleRes.result.code !== 200) {
       throw new Error('åˆ›å»ºæ—¥ç¨‹å¤±è´¥: ' + scheduleRes.result.message);
     }
     ```

  5. **æ·»åŠ æ•°æ®æ¸…ç†**ï¼š

     ```
     // åœ¨finallyå—ä¸­æ·»åŠ é€šçŸ¥å’Œæ—¥ç¨‹çš„æ¸…ç†
     ```

  6. **æ›´æ–°æ—¥æœŸæ ¼å¼**ï¼š

     ```
     eventDates: ['2025-08-15', '2025-08-16', '2025-08-17'], // ä½¿ç”¨æœªæ¥æ—¥æœŸ
     ```



- ä¿®å¤åçš„æµ‹è¯•ä»£ç 

```javascript
async function testFullBookingFlow() {
  console.group('ğŸ” ç«¯åˆ°ç«¯é¢„çº¦æµç¨‹æµ‹è¯•');
  let scheduleId = null;
  let notificationId = null;
  let currentUserOpenId = null;
  
  try {
    // 0. è·å–å½“å‰ç”¨æˆ·ID
    const userInfo = await wx.cloud.callFunction({ name: 'login' });
    currentUserOpenId = userInfo.result.openid;
    console.log('å½“å‰ç”¨æˆ·ID:', currentUserOpenId);
    
    // 1. ç”¨æˆ·Aåˆ›å»ºæ—¥ç¨‹
    console.log('ç”¨æˆ·Aåˆ›å»ºæ—¥ç¨‹...');
    const scheduleRes = await wx.cloud.callFunction({
      name: 'schedule-service',
      data: {
        action: 'save',
        data: {
          userId: currentUserOpenId, // æ·»åŠ ç”¨æˆ·ID
          eventDates: ['2025-08-15', '2025-08-16', '2025-08-17'],
          name: 'ç”¨æˆ·A',
          title: 'é¡¹ç›®ç»ç†'
        }
      }
    });
    
    if (scheduleRes.result.code !== 200) {
      throw new Error('åˆ›å»ºæ—¥ç¨‹å¤±è´¥: ' + scheduleRes.result.message);
    }
    
    scheduleId = scheduleRes.result.data._id;
    console.log('æ—¥ç¨‹åˆ›å»ºæˆåŠŸ, ID:', scheduleId);
    
    // 2. ç”¨æˆ·Aç”Ÿæˆåˆ†äº«é“¾æ¥
    console.log('ç”¨æˆ·Aç”Ÿæˆåˆ†äº«ä»¤ç‰Œ...');
    const tokenRes = await wx.cloud.callFunction({
      name: 'schedule-service',
      data: { 
        action: 'generateToken',
        data: { scheduleId } // æ·»åŠ æ—¥ç¨‹IDå‚æ•°
      }
    });
    
    if (tokenRes.result.code !== 200) {
      throw new Error('ç”Ÿæˆä»¤ç‰Œå¤±è´¥: ' + tokenRes.result.message);
    }
    
    const shareToken = tokenRes.result.data.token;
    console.log('åˆ†äº«ä»¤ç‰Œ:', shareToken);
    
    // 3. ç”¨æˆ·Bé€šè¿‡é“¾æ¥æŸ¥çœ‹æ—¥ç¨‹
    console.log('ç”¨æˆ·BæŸ¥çœ‹å…±äº«æ—¥ç¨‹...');
    const shareRes = await wx.cloud.callFunction({
      name: 'schedule-service',
      data: {
        action: 'getByToken',
        data: { token: shareToken }
      }
    });
    
    if (shareRes.result.code !== 200) {
      throw new Error('é€šè¿‡ä»¤ç‰Œè·å–æ—¥ç¨‹å¤±è´¥: ' + shareRes.result.message);
    }
    
    console.log('å…±äº«æ—¥ç¨‹è·å–æˆåŠŸ:', shareRes.result.data.title);
    
    // 4. ç”¨æˆ·Bå‘é€é¢„çº¦è¯·æ±‚
    console.log('ç”¨æˆ·Bå‘é€é¢„çº¦è¯·æ±‚...');
    const bookingRes = await wx.cloud.callFunction({
      name: 'notification-service',
      data: {
        action: 'create',
        data: {
          receiverId: currentUserOpenId, // ä½¿ç”¨åŠ¨æ€ç”¨æˆ·ID
          title: 'é¢„çº¦è¯·æ±‚',
          message: 'ç”¨æˆ·Bè¯·æ±‚é¢„çº¦æ‚¨çš„æ—¶é—´',
          type: 'incoming',
          details: {
            date: '2025-08-16',
            timeSlot: '14:00-15:00',
            purpose: 'é¡¹ç›®è®¨è®º'
          }
        }
      }
    });
    
    if (bookingRes.result.code !== 200) {
      throw new Error('åˆ›å»ºé€šçŸ¥å¤±è´¥: ' + bookingRes.result.message);
    }
    
    // ä¿®æ­£IDè·å–æ–¹å¼
    notificationId = bookingRes.result.data._id || bookingRes.result.data.id;
    console.log('é€šçŸ¥åˆ›å»ºæˆåŠŸ, ID:', notificationId);
    
    // 5. ç”¨æˆ·Aå¤„ç†è¯·æ±‚
    console.log('ç”¨æˆ·Aå¤„ç†é¢„çº¦è¯·æ±‚...');
    const updateRes = await wx.cloud.callFunction({
      name: 'notification-service',
      data: {
        action: 'update',
        data: {
          id: notificationId,
          status: 'read',
          type: 'confirmed'
        }
      }
    });
    
    if (updateRes.result.code !== 200) {
      throw new Error('æ›´æ–°é€šçŸ¥å¤±è´¥: ' + updateRes.result.message);
    }
    
    // 6. ç”¨æˆ·Bç¡®è®¤ç»“æœ
    console.log('ç”¨æˆ·Bç¡®è®¤ç»“æœ...');
    const resultRes = await wx.cloud.callFunction({
      name: 'notification-service',
      data: {
        action: 'get',
        data: { id: notificationId }
      }
    });
    
    if (resultRes.result.code === 200 && resultRes.result.data.type === 'confirmed') {
      console.log('âœ… ç«¯åˆ°ç«¯æµç¨‹æµ‹è¯•é€šè¿‡');
    } else {
      console.error('âŒ ç«¯åˆ°ç«¯æµç¨‹æµ‹è¯•å¤±è´¥');
      console.log('æœ€ç»ˆé€šçŸ¥çŠ¶æ€:', resultRes.result.data);
    }
    
  } catch (error) {
    console.error('æµ‹è¯•å¤±è´¥:', error);
  } finally {
    // æ¸…ç†æµ‹è¯•æ•°æ®
    console.log('å¼€å§‹æ¸…ç†æµ‹è¯•æ•°æ®...');
    
    if (notificationId) {
      try {
        await wx.cloud.callFunction({
          name: 'test-cleanup',
          data: {
            collection: 'notifications',
            id: notificationId
          }
        });
        console.log('âœ… é€šçŸ¥æ•°æ®æ¸…ç†å®Œæˆ');
      } catch (cleanError) {
        console.error('é€šçŸ¥æ¸…ç†å¤±è´¥:', cleanError);
      }
    }
    
    if (scheduleId) {
      try {
        await wx.cloud.callFunction({
          name: 'test-cleanup',
          data: {
            collection: 'schedules',
            id: scheduleId
          }
        });
        console.log('âœ… æ—¥ç¨‹æ•°æ®æ¸…ç†å®Œæˆ');
      } catch (cleanError) {
        console.error('æ—¥ç¨‹æ¸…ç†å¤±è´¥:', cleanError);
      }
    }
    
    console.groupEnd();
  }
}

// æ‰§è¡Œæµ‹è¯•
testFullBookingFlow();
```



### é¢„æœŸæµ‹è¯•æµç¨‹

1. è·å–å½“å‰ç”¨æˆ·ID
2. åˆ›å»ºæµ‹è¯•æ—¥ç¨‹
3. ç”Ÿæˆåˆ†äº«ä»¤ç‰Œ
4. é€šè¿‡ä»¤ç‰Œè·å–æ—¥ç¨‹ï¼ˆéªŒè¯åˆ†äº«åŠŸèƒ½ï¼‰
5. åˆ›å»ºé¢„çº¦é€šçŸ¥
6. æ›´æ–°é€šçŸ¥çŠ¶æ€ï¼ˆæ¨¡æ‹Ÿæ¥å—é¢„çº¦ï¼‰
7. éªŒè¯æœ€ç»ˆçŠ¶æ€
8. æ¸…ç†æµ‹è¯•æ•°æ®





æµ‹è¯•å®Œæˆï¼Œdownï¼